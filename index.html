<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8"/>
  <title>Storm Ops Map</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <!-- Leaflet (free map library) -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <!-- PapaParse (reads CSV/TSV easily) -->
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>

  <!-- Turf (checks if pin is inside polygon) -->
  <script src="https://cdn.jsdelivr.net/npm/@turf/turf@6/turf.min.js"></script>

  <style>
    body { margin: 0; padding: 0; font-family: Arial, sans-serif; }
    #map { width: 100%; height: 100vh; }
    .legend {
      position: absolute;
      bottom: 12px;
      left: 12px;
      background: white;
      padding: 10px 12px;
      border-radius: 10px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.2);
      font-size: 14px;
      line-height: 1.3;
      max-width: 340px;
    }
    .dot { display:inline-block; width:10px; height:10px; border-radius:50%; margin-right:6px; }

    .status {
      position:absolute;
      top:12px;
      left:12px;
      background:#fff;
      padding:10px 12px;
      border-radius:10px;
      box-shadow:0 2px 10px rgba(0,0,0,0.2);
      font-size:14px;
      max-width: 460px;
    }
    .status small { display:block; opacity:0.8; margin-top:6px; }
    a { word-break: break-word; }
  </style>
</head>

<body>
<div id="map"></div>

<div class="status" id="statusBox">
  Loading…
  <small>Open this via Live Server / localhost (not file://) so the sheets can load.</small>
</div>

<div class="legend">
  <div><span class="dot" style="background:#d9534f;"></span><b>Contract</b></div>
  <div><span class="dot" style="background:#0275d8;"></span><b>Subcontractor</b></div>
  <div style="margin-top:8px;">
    <b>Weather Alerts:</b> shaded polygons auto-update (NOAA).
  </div>
  <div style="margin-top:6px;">
    Pins inside an active alert get <b>highlighted</b>.
  </div>
</div>

<script>
/*** 1) YOUR PUBLISHED CSV LINKS ***/
const CONTRACTS_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vSpll5MNu-VzUpPg7cYPthmGuPGHpCDRwqpfTn1VlfZq57NTobDaxdpeiVlrtBb84raqj5kAKq387AJ/pub?output=csv";
const SUBS_URL      = "https://docs.google.com/spreadsheets/d/e/2PACX-1vQtCVV811NLAHOoNyGmU11deIXJbaTvXlCCPzCF5fY_LST2TdNHw9deAiI_uuc3wkvlUR8wBuzl6oHe/pub?output=csv";

/*** 2) MAP SETUP (free OpenStreetMap tiles) ***/
const map = L.map('map').setView([39, -98], 4);

L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
  maxZoom: 19,
  attribution: '© OpenStreetMap'
}).addTo(map);

/*** 3) LAYERS ***/
const alertsLayer = L.layerGroup().addTo(map);
const contractsLayer = L.layerGroup().addTo(map);
const subsLayer = L.layerGroup().addTo(map);

let contractMarkers = [];
let subMarkers = [];
let activeAlertPolygons = [];

let lastContractsCount = 0;
let lastSubsCount = 0;
let lastAlertsCount = 0;

function setStatus() {
  document.getElementById("statusBox").innerHTML =
    `<b>Storm Ops Map</b><br>
     Contracts loaded: <b>${lastContractsCount}</b><br>
     Subs loaded: <b>${lastSubsCount}</b><br>
     Active alert polygons: <b>${lastAlertsCount}</b>
     <small>If contracts/subs show 0: confirm LAT/LONG are numeric and run via localhost/Live Server.</small>`;
}

/*** HELPERS ***/
function safeNum(x) {
  const n = Number(String(x).trim());
  return Number.isFinite(n) ? n : null;
}

function getField(row, keys) {
  for (const k of keys) {
    if (row[k] !== undefined && row[k] !== null && String(row[k]).trim() !== "") return row[k];
  }
  return "";
}

function escapeHtml(str) {
  return String(str)
    .replaceAll("&", "&amp;")
    .replaceAll("<", "&lt;")
    .replaceAll(">", "&gt;");
}

function makePopup(title, lines, linkText, linkUrl) {
  const htmlLines = (lines || []).filter(Boolean).map(l => `<div>${l}</div>`).join("");
  const linkHtml = (linkUrl && linkText)
    ? `<div style="margin-top:8px;"><a href="${linkUrl}" target="_blank" rel="noopener">${escapeHtml(linkText)}</a></div>`
    : "";
  return `<div style="min-width:240px;">
    <b>${escapeHtml(title || "Details")}</b>
    ${htmlLines ? `<div style="margin-top:6px;">${htmlLines}</div>` : ""}
    ${linkHtml}
  </div>`;
}

// Styles
function contractStyle(isInsideAlert) {
  return {
    radius: isInsideAlert ? 10 : 7,
    color: isInsideAlert ? "#000" : "#fff",
    weight: isInsideAlert ? 3 : 1,
    fillColor: "#d9534f",
    fillOpacity: 0.95
  };
}
function subStyle(isInsideAlert) {
  return {
    radius: isInsideAlert ? 10 : 7,
    color: isInsideAlert ? "#000" : "#fff",
    weight: isInsideAlert ? 3 : 1,
    fillColor: "#0275d8",
    fillOpacity: 0.95
  };
}

// Robust parse: handles comma CSV or tab TSV
function parseSheet(url, onDone, onErr) {
  Papa.parse(url, {
    download: true,
    header: true,
    skipEmptyLines: true,
    delimiter: "", // auto-detect
    complete: (results) => onDone(results.data || []),
    error: (err) => {
      console.error("Sheet load error:", err);
      if (onErr) onErr(err);
    }
  });
}

/*** CONTRACTS (headers: Name State LAT LONG Expiration Link Contact Number Email) ***/
function loadContracts() {
  contractsLayer.clearLayers();
  contractMarkers = [];
  lastContractsCount = 0;
  setStatus();

  parseSheet(CONTRACTS_URL, (rows) => {
    let count = 0;

    rows.forEach(row => {
      const lat = safeNum(getField(row, ["LAT", "lat", "Latitude", "latitude"]));
      const lon = safeNum(getField(row, ["LONG", "LNG", "lng", "Longitude", "longitude"]));
      if (lat === null || lon === null) return;

      const name = getField(row, ["Name", "name"]);
      const state = getField(row, ["State", "state"]);
      const exp = getField(row, ["Expiration", "expiration"]);
      const link = getField(row, ["Link", "link"]);
      const contact = getField(row, ["Contact", "contact"]);
      const number = getField(row, ["Number", "number", "Phone", "phone"]);
      const email = getField(row, ["Email", "email"]);

      const marker = L.circleMarker([lat, lon], contractStyle(false)).addTo(contractsLayer);

      const popup = makePopup(
        name || "Contract",
        [
          state ? `<b>State:</b> ${escapeHtml(state)}` : "",
          exp ? `<b>Expiration:</b> ${escapeHtml(exp)}` : "",
          contact ? `<b>Contact:</b> ${escapeHtml(contact)}` : "",
          number ? `<b>Phone:</b> ${escapeHtml(number)}` : "",
          email ? `<b>Email:</b> ${escapeHtml(email)}` : ""
        ],
        link ? "Open Contract" : "",
        link || ""
      );

      marker.bindPopup(popup);
      contractMarkers.push({ marker, lat, lon });
      count++;
    });

    lastContractsCount = count;
    setStatus();
    updateHighlights();
  }, () => {
    document.getElementById("statusBox").innerHTML =
      `<b>Error loading Contracts</b><br>
       <small>Open via Live Server / localhost (not file://). Also confirm LAT and LONG columns are numeric.</small>`;
  });
}

/*** SUBS (headers: Subcontractor Name LAT LONG Address State Company Contact Company Email Company Phone Notes) ***/
function loadSubs() {
  subsLayer.clearLayers();
  subMarkers = [];
  lastSubsCount = 0;
  setStatus();

  parseSheet(SUBS_URL, (rows) => {
    let count = 0;

    rows.forEach(row => {
      const lat = safeNum(getField(row, ["LAT", "lat", "Latitude", "latitude"]));
      const lon = safeNum(getField(row, ["LONG", "LNG", "lng", "Longitude", "longitude"]));
      if (lat === null || lon === null) return;

      const subName = getField(row, ["Subcontractor Name"]);
      const address = getField(row, ["Address", "address"]);
      const state = getField(row, ["State", "state"]);
      const contact = getField(row, ["Company Contact", "Contact", "contact"]);
      const email = getField(row, ["Company Email", "Email", "email"]);
      const phone = getField(row, ["Company Phone", "Phone", "phone"]);
      const notes = getField(row, ["Notes", "notes"]);

      const title = subName
        ? subName
        : (address ? `Subcontractor @ ${address}` : "Subcontractor");

      const marker = L.circleMarker([lat, lon], subStyle(false)).addTo(subsLayer);

      const popup = makePopup(
        title,
        [
          address ? `<b>Address:</b> ${escapeHtml(address)}` : "",
          state ? `<b>State:</b> ${escapeHtml(state)}` : "",
          contact ? `<b>Contact:</b> ${escapeHtml(contact)}` : "",
          phone ? `<b>Phone:</b> ${escapeHtml(phone)}` : "",
          email ? `<b>Email:</b> ${escapeHtml(email)}` : "",
          notes ? `<b>Notes:</b> ${escapeHtml(notes)}` : ""
        ],
        "", ""
      );

      marker.bindPopup(popup);
      subMarkers.push({ marker, lat, lon });
      count++;
    });

    lastSubsCount = count;
    setStatus();
    updateHighlights();
  }, () => {
    document.getElementById("statusBox").innerHTML =
      `<b>Error loading Subs</b><br>
       <small>Open via Live Server / localhost (not file://). Also confirm LAT and LONG columns are numeric.</small>`;
  });
}

/*** NOAA ALERTS (AUTOMATIC) ***/
async function loadNOAAAlerts() {
  alertsLayer.clearLayers();
  activeAlertPolygons = [];
  lastAlertsCount = 0;
  setStatus();

  try {
    const res = await fetch("https://api.weather.gov/alerts/active");
    const geojson = await res.json();

    let polyCount = 0;

    geojson.features.forEach(f => {
      if (!f.geometry) return;

      activeAlertPolygons.push(f);
      polyCount++;

      const eventName = f.properties?.event || "Weather Alert";
      const areaDesc = f.properties?.areaDesc || "";
      const ends = f.properties?.ends || f.properties?.expires || "";
      const link = f.properties?.uri || "";

      const layer = L.geoJSON(f, {
        style: { color: "#ff0000", weight: 2, fillOpacity: 0.18 }
      }).addTo(alertsLayer);

      layer.bindPopup(makePopup(
        eventName,
        [
          areaDesc ? `<b>Area:</b> ${escapeHtml(areaDesc)}` : "",
          ends ? `<b>Ends:</b> ${escapeHtml(ends)}` : ""
        ],
        link ? "Open NOAA Alert" : "",
        link || ""
      ));
    });

    lastAlertsCount = polyCount;
    setStatus();
    updateHighlights();
  } catch (err) {
    console.error("NOAA alert load error:", err);
    document.getElementById("statusBox").innerHTML =
      `<b>Error loading NOAA alerts</b><br><small>${escapeHtml(String(err))}</small>`;
  }
}

/*** HIGHLIGHT PINS INSIDE ALERT POLYGONS ***/
function pointInsideAnyAlert(lon, lat) {
  if (!activeAlertPolygons.length) return false;
  const pt = turf.point([lon, lat]);

  for (const alert of activeAlertPolygons) {
    try {
      const polyFeature = turf.feature(alert.geometry);
      if (turf.booleanPointInPolygon(pt, polyFeature)) return true;
    } catch {}
  }
  return false;
}

function updateHighlights() {
  contractMarkers.forEach(o => {
    const inside = pointInsideAnyAlert(o.lon, o.lat);
    o.marker.setStyle(contractStyle(inside));
  });
  subMarkers.forEach(o => {
    const inside = pointInsideAnyAlert(o.lon, o.lat);
    o.marker.setStyle(subStyle(inside));
  });
}

/*** AUTO-REFRESH ***/
function start() {
  setStatus();
  loadContracts();
  loadSubs();
  loadNOAAAlerts();

  setInterval(loadNOAAAlerts, 5 * 60 * 1000);          // alerts every 5 min
  setInterval(() => { loadContracts(); loadSubs(); }, 2 * 60 * 1000); // sheets every 2 min
}

start();
</script>

</body>
</html>

